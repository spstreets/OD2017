---
title: "Exploring OD2017 data"
output: github_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE
)

library(tidyverse)
library(sf)
library(tmap)
load("C:/Users/Lucas/Downloads/OD2017/OD2017.rda")
```

I create this separated document to be the main reference on the exploratory data analysis. The data set is at the trip level and I take advantage of the survey design and use the expansion factor (for the trips) in all the graphs and analysis here. The survey implies that there are `r sum(OD_2017_v1$fe_via, na.rm=TRUE)` trips/day in the São Paulo Metro Region.

### Key variables

The data set contains a lot of socioeconomic variables. Since our interest relies on trips, flows and mode choices, the analyses so far are at the trip level. In this context, the variables that contain a the modes used in each trip are the main ones (`modo1`, `modo2`, `modo3`, and `modo4`). There is also the coordinates for each residence (`co_dom_x` and `co_dom_y`) and workplaces (`co_tr1_x` and `co_tr1_y`), and obviously the origin and destination zones and coordinates (e.g. `zona_o`, `co_o_x`, `co_o_y`) and euclidean distance. As you can see in the graph below, the vast majority of trips are made using just one mode. I use the main mode used in the trip (`modoprin`) in the remaining graphs. 

```{r, echo=FALSE}

OD_2017_v1 = OD_2017_v1 %>%
  mutate(
    n_modes = case_when(
      !is.na(modo1) & is.na(modo2) & is.na(modo3) & is.na(modo4)    ~ "1",
      !is.na(modo1) & !is.na(modo2) & is.na(modo3) & is.na(modo4)   ~ "2",
      !is.na(modo1) & !is.na(modo2) & !is.na(modo3) & is.na(modo4)  ~ "3",
      !is.na(modo1) & !is.na(modo2) & !is.na(modo3) & !is.na(modo4) ~ "4"
    )
  )
  

OD_2017_v1 %>%
  ggplot() +
  geom_bar(aes(n_modes, weight=fe_via)) +
  scale_y_continuous(name = "Thousands of trips / day",
                     labels=function(x) format(x/1000,
                                               big.mark = ",",
                                               decimal.mark = ".",
                                               scientific = FALSE)
                     ) +
  ggtitle("Number of modes used in each trip") +
  xlab("") +
  theme_bw()

```


### Different ways of defining modes

I aggregate the different names used for similar things. And this is the resulting distribution of trips for each mode.

```{r, echo=FALSE}

OD_2017_v1 = OD_2017_v1 %>%
  dplyr::mutate(
    modo_simples = case_when(
      modoprin==1 | modoprin==2 | modoprin==3 ~ "Metrô, trem e monotrilho",
      modoprin==4 | modoprin==5 | modoprin==6 ~ "Ônibus",
      modoprin==7 | modoprin==8            ~ "Fretado e Escolar",
      modoprin==9 | modoprin==10           ~ "Automóvel",
      modoprin==11 | modoprin==12          ~ "Táxi e derivados",
      modoprin==13 | modoprin==14          ~ "Moto",
      modoprin==15                      ~ "Bicicleta",
      modoprin==16                      ~ "A pé",
      modoprin==17                      ~ "Outros",
    )
  )

OD_2017_v1 %>%
  filter(!is.na(modoprin)) %>%
  ggplot() +
  geom_bar(aes(modo_simples, weight=fe_via)) +
  scale_y_continuous(name = "Thousands of trips / day",
                     labels=function(x) format(x/1000,
                                               big.mark = ",",
                                               decimal.mark = ".",
                                               scientific = FALSE)
                     ) +
  ggtitle("Aggregating similar modes") +
  xlab("") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))

```


### Recategorisation of modes

I tried two different recategorisations (see code for the choices).The first is based on the "vehicle" itself, and the other relies on the "role" of the individual while in the trip.

```{r, echo=FALSE}

OD_2017_v1 = OD_2017_v1 %>%
  dplyr::mutate(
    mode_recat1 = case_when(
      modoprin %in% 1:6 ~ "Public transport",
      modoprin %in% 9:10 ~ "Car",
      modoprin %in% 13:14 ~ "Motorcycle",
      modoprin == 15 ~ "Bicycle",
      modoprin == 16 ~ "On foot",
      modoprin == 17 | modoprin == 12 | modoprin == 11 | modoprin == 7 | modoprin == 8 ~ "Other"
    )
  )

OD_2017_v1 %>%
  filter(!is.na(modoprin)) %>%
  ggplot() +
  geom_bar(aes(mode_recat1, weight=fe_via)) +
  scale_y_continuous(name = "Thousands of trips / day",
                     labels=function(x) format(x/1000,
                                               big.mark = ",",
                                               decimal.mark = ".",
                                               scientific = FALSE)
                     ) +
  ggtitle("Recategorisation of modes 1") +
  xlab("")+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))

```

```{r, echo=FALSE}

OD_2017_v1 = OD_2017_v1 %>%
  dplyr::mutate(
    mode_recat2 = case_when(
      modoprin %in% 1:6 ~ "Public transport",
      modoprin == 9 | modoprin == 13 ~ "Driving",
      modoprin==10 | modoprin==14 ~ "Rider",
      modoprin %in% c(7, 8, 11, 12) ~ "Private transport passenger",
      modoprin==15 ~ "Cycling",
      modoprin==16 ~ "Walking",
      modoprin==17 ~ "Other"
    )
  )

OD_2017_v1 %>%
  filter(!is.na(modoprin)) %>%
  ggplot() +
  geom_bar(aes(mode_recat2, weight=fe_via)) +
  scale_y_continuous(name = "Thousands of trips / day",
                     labels=function(x) format(x/1000,
                                               big.mark = ",",
                                               decimal.mark = ".",
                                               scientific = FALSE)
                     ) +
  ggtitle("Recategorisation of modes - 2") +
  xlab("") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))

```


### Basic geographic analysis

```{r, include=FALSE}

zonas_od = st_read("C:/Users/Lucas/Downloads/OD2017/shapefiles/Zonas_2017_region.shp")
tmap_mode("plot")

```

```{r, echo=FALSE}

OD = OD_2017_v1 %>%
  filter(!is.na(modoprin)) %>%
  select(zona_o, zona_d, modoprin, fe_via) %>%
  mutate(
    public = ifelse(modoprin %in% 1:6, 1, 0)*fe_via,
    car = ifelse(modoprin %in% 9:10, 1, 0)*fe_via,
    motorcycle = ifelse(modoprin %in% 13:14, 1, 0)*fe_via,
    bike = ifelse(modoprin == 15, 1, 0)*fe_via,
    foot = ifelse(modoprin == 16, 1, 0)*fe_via,
    other = ifelse(modoprin %in% c(7, 8, 11, 12, 17), 1, 0)*fe_via
         ) %>%
  select(zona_o, zona_d, public, car, motorcycle, bike, foot, other) %>%
  group_by(zona_o, zona_d) %>%
  summarise_all(sum) %>%
  mutate(trips = public + car + motorcycle + bike + foot + other)

# check:
# sum(OD$public) + sum(OD$car) + sum(OD$motorcycle) + sum(OD$bike) + sum(OD$foot) + sum(OD$other)

origin = OD %>%
  ungroup() %>%
  select(-zona_d) %>%
  group_by(zona_o) %>%
  summarise_all(sum) %>%
  rename(trips_o = trips) %>%
  select(zona_o, trips_o)

destination = OD %>%
  ungroup() %>%
  select(-zona_o) %>%
  group_by(zona_d) %>%
  summarise_all(sum) %>%
  rename(trips_d = trips) %>%
  select(zona_d, trips_d)

zonas_od = zonas_od %>%
  left_join(origin, by = c("NumeroZona" = "zona_o")) %>%
  left_join(destination, by=c("NumeroZona" = "zona_d"))


tm_shape(zonas_od) + tm_fill(c("trips_o", "trips_d"), 
                             style = "cont",
                             title = "Trips")  +
  tm_facets(free.scales = FALSE, ncol = 2) +
  tm_layout(title = "São Paulo Metro Region",
            panel.labels = c("Zone of origin", "Zone of destination"),
            legend.outside = TRUE)

```

Plotting only the São Paulo City.

```{r, echo=FALSE}

zonas_od_sp = zonas_od %>%
  filter(NomeMunici=="São Paulo")

tm_shape(zonas_od_sp) + tm_fill(c("trips_o", "trips_d"),
                                style = "cont",
                                title = "Trips"
                                )  +
  tm_borders(col = "black", lwd = 0.1) + 
  tm_facets(free.scales = FALSE, ncol = 2) +
  tm_layout(title = "São Paulo Metro City",
            panel.labels = c("Zone of origin", "Zone of destination"),
            inner.margins = c(0, .02, .02, .02))


```












